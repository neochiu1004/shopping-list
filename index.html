<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä»£è³¼åˆ†å¸³ (å®Œç¾åŒ¯å‡ºç‰ˆ)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #9370DB; 
            --primary-dark: #663399;
            --bg-color: #f3f4f6;
            --text-color: #374151;
            --error-color: #ef4444;
            --success-color: #10b981;
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            padding-bottom: 140px;
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1 { text-align: center; color: var(--primary-color); margin-top: 0; }

        /* ç¯©é¸èˆ‡æˆå“¡å€å¡Š */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; background: #f8fafc; padding: 10px; border-radius: 8px; flex-wrap: wrap; }
        .filter-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; flex: 1; }
        .filter-select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }

        .member-section { border-bottom: 2px dashed #e2e8f0; padding-bottom: 15px; margin-bottom: 15px; }
        .member-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .member-tag { background-color: var(--primary-color); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .member-remove { cursor: pointer; background: rgba(255,255,255,0.3); border-radius: 50%; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; font-size: 12px; }

        .tabs-wrapper { display: flex; overflow-x: auto; gap: 5px; border-bottom: 2px solid var(--primary-color); margin-bottom: 15px; padding-bottom: 2px; }
        .tab { padding: 10px 20px; background: #e2e8f0; border-radius: 8px 8px 0 0; cursor: pointer; white-space: nowrap; color: #64748b; font-weight: bold; }
        .tab.active { background: var(--primary-color); color: white; }

        .btn-icon { border: none; cursor: pointer; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-export { background: #3b82f6; color: white; }
        .btn-export:hover { background: #2563eb; }

        .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; }
        th:first-child, td:first-child { text-align: left; min-width: 140px; border-right: 2px solid #e2e8f0; background-color: inherit; }
        tbody td:first-child { background-color: #fff; }

        .note { font-size: 0.75em; color: #6b7280; display: block; }
        input[type="number"] { width: 50px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; }
        .input-error { background-color: #fef2f2; border-color: var(--error-color) !important; color: var(--error-color); }
        
        /* å¼·åŒ–æ‰“å‹¾é¡¯ç¤º */
        .remain-ok { color: var(--success-color); font-weight: 900; font-size: 1.2em; }
        .remain-error { color: var(--error-color); font-weight: bold; }

        /* åº•éƒ¨æ‡¸æµ®ç¸½è¨ˆåˆ— */
        .total-bar {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(8px);
            color: white; border-radius: 16px; padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 100;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }

        .total-scroll-area { display: flex; overflow-x: auto; gap: 20px; flex: 1; align-items: center; }
        .total-grand { font-size: 1.1rem; font-weight: bold; color: #fbbf24; padding-right: 20px; border-right: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .total-user { display: flex; flex-direction: column; font-size: 0.85rem; min-width: 60px; text-align: center; }
        .total-user span { font-weight: bold; font-size: 1rem; }

        @media (max-width: 600px) {
            .total-bar { flex-direction: column; align-items: stretch; bottom: 10px; }
            .total-scroll-area { padding-bottom: 10px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container" id="captureTarget">
    <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä»£è³¼åˆ†å¸³</h1>

    <div class="member-section">
        <div style="font-weight: bold; color: #64748b; margin-bottom: 10px;">âš™ï¸ æˆå“¡è¨­å®š</div>
        <div class="member-tags" id="memberTags"></div>
        <div style="display: flex; gap: 10px;" data-html2canvas-ignore="true">
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥åå­—..." style="width: 120px; padding: 6px; border-radius:6px; border:1px solid #ccc;">
            <button class="btn-icon btn-primary" onclick="addMember()">+ æ–°å¢</button>
        </div>
    </div>

    <div class="tabs-wrapper" id="tabsHeader" data-html2canvas-ignore="true"></div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <input type="text" id="orderName" onchange="updateOrderName(this.value)" 
               style="font-size:1.3em; font-weight:bold; border:none; border-bottom:1px solid #ccc; width:200px; color:var(--primary-dark);" >
        <button class="btn-icon btn-danger" onclick="deleteCurrentOrder()" data-html2canvas-ignore="true">ğŸ—‘ï¸ åˆªé™¤è¨‚å–®</button>
    </div>

    <div class="filter-bar" data-html2canvas-ignore="true">
        <input type="text" id="searchKeyword" class="filter-input" placeholder="ğŸ” æœå°‹å“å..." oninput="renderTable()">
        <select id="statusFilter" class="filter-select" onchange="renderTable()">
            <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
            <option value="incomplete">ğŸ”´ æœªè²·é½Š</option>
            <option value="completed">ğŸŸ¢ å·²è²·é½Š</option>
            <option value="over">âš ï¸ è²·å¤šäº†</option>
        </select>
    </div>

    <div class="table-responsive">
        <table id="mainTable">
            <thead><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div style="margin-top: 15px; padding: 10px; background: #f1f5f9; border-radius: 8px; display: flex; gap:8px; flex-wrap:wrap;" data-html2canvas-ignore="true">
        <input type="text" id="addItemName" placeholder="å“é …" style="flex:2; padding:8px; border:1px solid #ccc; border-radius:6px;">
        <input type="number" id="addItemPrice" placeholder="å–®åƒ¹" style="width:70px; padding:8px; border:1px solid #ccc; border-radius:6px;">
        <input type="number" id="addItemLimit" placeholder="åŸè³¼" style="width:60px; padding:8px; border:1px solid #ccc; border-radius:6px;">
        <button class="btn-icon btn-primary" onclick="addNewItem()">åŠ å…¥</button>
    </div>

    <div style="height: 20px;"></div>
    <div style="text-align: center; color: #999; font-size: 0.8em; margin-top:10px;">
        æˆªåœ–æ™‚é–“: <span id="captureTime"></span>
    </div>
</div>

<div class="total-bar">
    <div class="total-scroll-area" id="totalScrollArea"></div>
    <button class="btn-icon btn-export" onclick="exportImage()">ğŸ“¸ åŒ¯å‡ºåœ–ç‰‡</button>
</div>

<script>
    const defaultItems = [
        { name: "è‘‰é»ƒç´ 100 + èŠéº»ç´ ", note: "1çµ„(2åŒ…)", price: 9164, limit: 1 },
        { name: "é˜²é¢¨é€šè–æ•£ Z", note: "æ¼¢æ–¹æ¸›è‚¥", price: 5318, limit: 2 },
        { name: "æŠ¹èŒ¶ææ‹‰ç±³è˜‡å·§å…‹åŠ›", note: "", price: 828, limit: 2 },
        { name: "Alfort å¸†èˆ¹å·§å…‹åŠ›", note: "", price: 275, limit: 1 },
        { name: "é¾è§’æ•£ å–‰ç³–", note: "é»‘é†‹æ —è—è“", price: 302, limit: 1 },
        { name: "Ora2 Premium ç‰™è†", note: "èŠ³é¦™è–„è·", price: 367, limit: 1 },
        { name: "NONIO ç‰™è†", note: "è—¥ç”¨æ¸…æ¶¼è–„è·", price: 302, limit: 1 },
        { name: "DHC æ­¦é´è‘‰", note: "æ§ç³– 20æ—¥", price: 597, limit: 4 },
        { name: "DHC ç¶­ä»–å‘½C", note: "20æ—¥ä»½", price: 155, limit: 7 },
        { name: "é¾è§’æ•£ ç›´æœé¡†ç²’", note: "è–„è·å‘³", price: 275, limit: 2 },
        { name: "KitKat å·§å…‹åŠ›", note: "æ¿ƒåšæŠ¹èŒ¶", price: 275, limit: 4 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "è‘¡è„", price: 109, limit: 5 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "éºé¦™è‘¡è„", price: 109, limit: 5 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "20ä¸–ç´€æ¢¨", price: 109, limit: 3 },
        { name: "é¾è§’æ•£ ç›´æœé¡†ç²’", note: "æ°´èœœæ¡ƒå‘³", price: 275, limit: 1 },
        { name: "DHC äºé‰› (é‹…)", note: "20æ—¥ä»½", price: 146, limit: 1 },
        { name: "DHC ç¶œåˆç¶­ä»–å‘½Bç¾¤", note: "20æ—¥ä»½", price: 164, limit: 2 },
        { name: "DHC ç”²æ®¼ç´ ", note: "20æ—¥ä»½", price: 330, limit: 2 },
        { name: "DHC è‚è‡Ÿç²¾è¯+é³¥æ°¨é…¸", note: "20æ—¥ä»½(è§£é…’)", price: 735, limit: 1 },
        { name: "é€Ÿå¦™åœ“ (å´æŸè‘‰) å–‰ç³–", note: "å‚³çµ±è‰æœ¬", price: 238, limit: 1 },
        { name: "DHC æ¸›è‚¥å¨åŠ›", note: "Diet Power", price: 902, limit: 4 }
    ];

    const STORAGE_KEY = 'hokkaido_shopping_final_v2';
    let appData = { users: ["Neo", "Ryan"], orders: [], activeOrderId: null };

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) appData = JSON.parse(saved);
        else createNewOrder(false);
        
        if (appData.orders.length === 0) createNewOrder(false);
        if (appData.users.length === 0) appData.users = ["Neo", "Ryan"];
        if (!appData.activeOrderId || !appData.orders.find(o => o.id === appData.activeOrderId)) {
            appData.activeOrderId = appData.orders[0].id;
        }
        renderAll();
    }

    function createNewOrder(refresh = true) {
        const newId = 'order_' + Date.now();
        const items = defaultItems.map(p => ({ ...p, quantities: {} }));
        appData.orders.push({ id: newId, name: `è³¼ç‰©æ¸…å–® ${appData.orders.length + 1}`, items: items });
        appData.activeOrderId = newId;
        saveData();
        if (refresh) renderAll();
    }

    function addMember() {
        const name = document.getElementById('newMemberName').value.trim();
        if (!name || appData.users.includes(name)) return;
        appData.users.push(name);
        document.getElementById('newMemberName').value = '';
        saveData();
        renderAll();
    }

    function removeMember(name) {
        if (!confirm(`ç¢ºå®šç§»é™¤ ${name}ï¼Ÿ`)) return;
        appData.users = appData.users.filter(u => u !== name);
        appData.orders.forEach(order => {
            order.items.forEach(item => { if (item.quantities[name]) delete item.quantities[name]; });
        });
        saveData();
        renderAll();
    }

    function updateQuantity(idx, user, val) {
        getCurrentOrder().items[idx].quantities[user] = parseFloat(val) || 0;
        saveData();
        calculateTotals();
        renderTable(); 
    }

    function addNewItem() {
        const name = document.getElementById('addItemName').value.trim();
        const price = parseFloat(document.getElementById('addItemPrice').value);
        const limit = parseInt(document.getElementById('addItemLimit').value);
        if (!name || isNaN(price) || isNaN(limit)) return alert('è«‹å¡«å¯«å®Œæ•´');
        getCurrentOrder().items.push({ name, price, limit, note: 'è‡ªè¨‚', quantities: {} });
        document.getElementById('addItemName').value = '';
        document.getElementById('addItemPrice').value = '';
        document.getElementById('addItemLimit').value = '';
        saveData();
        renderTable();
        calculateTotals();
    }

    function deleteItem(index) {
        if(confirm('åˆªé™¤æ­¤å“é …ï¼Ÿ')) {
            getCurrentOrder().items.splice(index, 1);
            saveData();
            renderTable();
            calculateTotals();
        }
    }

    function deleteCurrentOrder() {
        if (appData.orders.length <= 1) return alert('è‡³å°‘éœ€ä¿ç•™ä¸€å¼µ');
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) {
            appData.orders = appData.orders.filter(o => o.id !== appData.activeOrderId);
            appData.activeOrderId = appData.orders[0].id;
            saveData();
            renderAll();
        }
    }

    function renderAll() {
        renderMembers();
        renderTabs();
        renderTable();
        calculateTotals();
    }

    function renderMembers() {
        document.getElementById('memberTags').innerHTML = appData.users.map(u => 
            `<div class="member-tag">${u}<span class="member-remove" onclick="removeMember('${u}')">Ã—</span></div>`
        ).join('');
    }

    function renderTabs() {
        const container = document.getElementById('tabsHeader');
        let html = appData.orders.map(o => 
            `<div class="tab ${o.id === appData.activeOrderId ? 'active' : ''}" onclick="switchTab('${o.id}')">${o.name}</div>`
        ).join('');
        html += `<button class="btn-icon" style="margin-left:5px; background:#e2e8f0;" onclick="createNewOrder()">+</button>`;
        container.innerHTML = html;
        document.getElementById('orderName').value = getCurrentOrder().name;
    }

    function renderTable() {
        const order = getCurrentOrder();
        const keyword = document.getElementById('searchKeyword').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        
        let header = `<th>å“é …</th><th>åŸè³¼</th><th>å–®åƒ¹</th>`;
        appData.users.forEach(u => header += `<th>${u}</th>`);
        header += `<th>å‰©é¤˜</th><th data-html2canvas-ignore="true">åˆª</th>`;
        document.getElementById('tableHeader').innerHTML = header;

        document.getElementById('tableBody').innerHTML = order.items.map((item, idx) => {
            let totalAssigned = 0;
            appData.users.forEach(u => totalAssigned += (item.quantities[u] || 0));
            const remaining = item.limit - totalAssigned;
            
            if (keyword && !item.name.toLowerCase().includes(keyword)) return '';
            if (status === 'incomplete' && remaining <= 0) return '';
            if (status === 'completed' && remaining !== 0) return '';
            if (status === 'over' && remaining >= 0) return '';

            let remainClass = remaining < 0 ? 'remain-error' : (remaining === 0 ? 'remain-ok' : 'remain-col');
            let inputClass = remaining < 0 ? 'input-error' : '';
            let remainText = remaining === 0 ? 'âœ”' : remaining;

            let row = `<tr>
                <td><div style="font-weight:500;">${item.name}</div>${item.note ? `<span class="note">${item.note}</span>` : ''}</td>
                <td style="color:#64748b;">${item.limit}</td>
                <td style="font-family:monospace; color:#7c3aed;">${item.price}</td>`;
            
            appData.users.forEach(u => {
                const q = item.quantities[u];
                row += `<td><input type="number" class="${inputClass}" value="${q===0?'':(q||'')}" placeholder="0" min="0" onchange="updateQuantity(${idx}, '${u}', this.value)"></td>`;
            });

            row += `<td class="${remainClass}">${remainText}</td>
                    <td data-html2canvas-ignore="true"><button class="btn-icon" style="color:#ccc; background:none;" onclick="deleteItem(${idx})">Ã—</button></td></tr>`;
            return row;
        }).join('');
    }

    function calculateTotals() {
        const order = getCurrentOrder();
        const totals = {}; 
        let grandTotal = 0;
        appData.users.forEach(u => totals[u] = 0);
        order.items.forEach(item => {
            appData.users.forEach(u => totals[u] += (item.quantities[u] || 0) * item.price);
        });
        Object.values(totals).forEach(v => grandTotal += v);

        let html = `<div class="total-grand">ç¸½è¨ˆ $${grandTotal.toLocaleString()}</div>`;
        appData.users.forEach(u => html += `<div class="total-user">${u}<span>$${totals[u].toLocaleString()}</span></div>`);
        document.getElementById('totalScrollArea').innerHTML = html;
    }

    // --- å¼·åŒ–ç‰ˆåŒ¯å‡ºåŠŸèƒ½ (è§£æ±ºæ•¸å­—é¡¯ç¤ºèˆ‡æ‰“å‹¾æ¶ˆå¤±å•é¡Œ) ---
    function exportImage() {
        const target = document.getElementById("captureTarget");
        const totalSource = document.getElementById("totalScrollArea");
        const btn = document.querySelector('.btn-export');
        
        // 1. æ›´æ–°æ™‚é–“
        const now = new Date();
        document.getElementById('captureTime').innerText = `æ›´æ–°æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

        btn.innerText = "ğŸ“¸ è£½ä½œä¸­...";

        // ä½¿ç”¨ html2canvas çš„ onclone åŠŸèƒ½ä¾†ä¿®æ”¹æˆªåœ–ç•¶ä¸‹çš„ç‹€æ…‹
        html2canvas(target, {
            scale: 2, // é«˜è§£æåº¦
            backgroundColor: "#ffffff",
            useCORS: true,
            scrollY: -window.scrollY,
            onclone: (clonedDoc) => {
                // [ä¿®æ­£1]ï¼šç¢ºä¿è¡¨æ ¼å®Œæ•´å±•é–‹ï¼Œè§£æ±ºã€Œå³é‚Šæ‰“å‹¾è¢«åˆ‡æ‰ã€çš„å•é¡Œ
                const tableResp = clonedDoc.querySelector('.table-responsive');
                if (tableResp) {
                    tableResp.style.overflow = 'visible'; 
                    tableResp.style.width = 'fit-content';
                }
                const container = clonedDoc.querySelector('.container');
                container.style.width = 'fit-content';
                container.style.maxWidth = 'none';

                // [ä¿®æ­£2]ï¼šå°‡æ‰€æœ‰ input è½‰æ›ç‚ºæ–‡å­— spanï¼Œè§£æ±ºã€Œæ¬„ä½å¤ªå°çœ‹ä¸åˆ°æ•¸å­—ã€çš„å•é¡Œ
                const inputs = clonedDoc.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    const val = input.value;
                    const span = clonedDoc.createElement('span');
                    span.innerText = val;
                    span.style.fontWeight = 'bold';
                    span.style.fontSize = '1.1em';
                    // æ ¹æ“šæ˜¯å¦æœ‰å€¼é¡¯ç¤ºé¡è‰²ï¼Œè‹¥ç‚ºç©ºæˆ–æ˜¯0å‰‡é¡¯ç¤ºæ·¡è‰²
                    span.style.color = (val && val != '0') ? '#374151' : '#ccc'; 
                    
                    // æ›¿æ›åŸæœ¬çš„ input
                    if(input.parentNode) {
                        input.parentNode.replaceChild(span, input);
                    }
                });

                // æ’å…¥ç¸½è¨ˆåˆ—åˆ°æˆªåœ–ä¸­ (ç¾åŒ–ç‰ˆ)
                const footer = clonedDoc.createElement('div');
                footer.innerHTML = totalSource.innerHTML;
                Object.assign(footer.style, {
                    backgroundColor: "#2c3e50",
                    color: "white",
                    padding: "20px",
                    borderRadius: "12px",
                    marginTop: "20px",
                    display: "flex",
                    flexWrap: "wrap",
                    justifyContent: "space-around",
                    alignItems: "center",
                    gap: "15px",
                    width: "100%", // ç¢ºä¿å¯¬åº¦è¶³å¤ 
                    boxSizing: "border-box"
                });
                clonedDoc.getElementById('captureTarget').appendChild(footer);
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ShoppingList_${getCurrentOrder().name}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            
            btn.innerText = "ğŸ“¸ åŒ¯å‡ºåœ–ç‰‡";
            document.getElementById('captureTime').innerText = "";
        }).catch(err => {
            alert("æˆªåœ–å¤±æ•—");
            console.error(err);
            btn.innerText = "ğŸ“¸ åŒ¯å‡ºåœ–ç‰‡";
        });
    }

    function getCurrentOrder() { return appData.orders.find(o => o.id === appData.activeOrderId); }
    function switchTab(id) { appData.activeOrderId = id; saveData(); renderAll(); }
    function updateOrderName(val) { getCurrentOrder().name = val; saveData(); renderTabs(); }
    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }

    init();
</script>

</body>
</html>
