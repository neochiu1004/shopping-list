<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‡¯ğŸ‡µ æ—¥æœ¬åˆ†å¸³è¨ˆç®—è¡¨ (å¤šäººç‰ˆ)</title>
    <style>
        :root {
            /* åŒ—æµ·é“è–°è¡£è‰é…è‰² */
            --primary-color: #9370DB; 
            --primary-dark: #663399;
            --bg-color: #f3f4f6;
            --text-color: #374151;
            --error-color: #ef4444;
            --success-color: #10b981;
            --border-radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            padding-bottom: 120px; /* çµ¦åº•éƒ¨æ‡¸æµ®æ¬„ç©ºé–“ */
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.5rem;
        }

        /* --- æˆå“¡ç®¡ç†å€å¡Š --- */
        .member-section {
            background-color: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: bold;
            color: #64748b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .member-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .member-tag {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .member-remove {
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .member-remove:hover { background: rgba(255,0,0,0.5); }

        .add-member-form {
            display: flex;
            gap: 10px;
        }

        /* --- åˆ†é æ¨™ç±¤ --- */
        .tabs-wrapper {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 2px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            white-space: nowrap;
            color: #64748b;
            font-weight: 600;
            transition: 0.2s;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-danger:hover { background: #fca5a5; }

        /* --- è¡¨æ ¼å®¹å™¨ (æ”¯æ´æ©«å‘æ²å‹•) --- */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* é˜²æ­¢åœ¨æ‰‹æ©Ÿä¸Šæ“ æˆä¸€åœ˜ */
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* å›ºå®šç¬¬ä¸€æ¬„ (å“å) */
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background-color: inherit; /* è·Ÿéš¨çˆ¶å±¤èƒŒæ™¯ */
            z-index: 20; /* æ¯”è¡¨é ­é«˜ä¸€é»æˆ–æ˜¯åŒå±¤ç´š */
            text-align: left;
            min-width: 140px;
            border-right: 2px solid #e2e8f0;
        }
        tbody td:first-child { background-color: #fff; }
        thead th:first-child { background-color: var(--primary-color); }

        .note {
            font-size: 0.75em;
            color: #6b7280;
            display: block;
            margin-top: 2px;
        }

        input[type="number"] {
            width: 50px;
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
        }
        input[type="number"]:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        .input-error { background-color: #fef2f2; border-color: var(--error-color) !important; color: var(--error-color); }
        
        .remain-ok { color: var(--success-color); font-weight: bold; }
        .remain-error { color: var(--error-color); font-weight: bold; }

        /* --- åº•éƒ¨æ‡¸æµ®ç¸½è¨ˆåˆ— --- */
        .total-bar {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            color: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            overflow-x: auto; /* æ”¯æ´å¤šäººæ™‚æ©«å‘æ»‘å‹• */
            gap: 20px;
        }

        .total-grand {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fbbf24; /* é‡‘é»ƒè‰² */
            padding-right: 20px;
            border-right: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
        }

        .total-user {
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
            min-width: 60px;
            text-align: center;
        }
        .total-user span { font-weight: bold; font-size: 1rem; }

        /* --- æ–°å¢é …ç›®å€ --- */
        .add-item-row {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä»£è³¼åˆ†å¸³ (å¤šäººç‰ˆ)</h1>

    <div class="member-section">
        <div class="section-title">âš™ï¸ æˆå“¡è¨­å®š (é»æ“Š X ç§»é™¤)</div>
        <div class="member-tags" id="memberTags">
            </div>
        <div class="add-member-form">
            <input type="text" id="newMemberName" placeholder="è¼¸å…¥åå­—..." style="width: 120px; padding: 6px;">
            <button class="btn-icon btn-primary" onclick="addMember()">+ æ–°å¢æˆå“¡</button>
        </div>
    </div>

    <div class="tabs-wrapper" id="tabsHeader">
        </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <input type="text" id="orderName" onchange="updateOrderName(this.value)" 
               style="font-size:1.1em; font-weight:bold; border:none; border-bottom:1px solid #ccc; width:150px;" >
        
        <div>
            <button class="btn-icon btn-danger" onclick="deleteCurrentOrder()">ğŸ—‘ï¸ åˆªé™¤è¨‚å–®</button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="mainTable">
            <thead>
                <tr id="tableHeader">
                    </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div class="add-item-row">
        <input type="text" id="addItemName" placeholder="å“é …åç¨±" style="flex:2; min-width:100px;">
        <input type="number" id="addItemPrice" placeholder="å–®åƒ¹" style="width:70px;">
        <input type="number" id="addItemLimit" placeholder="åŸè³¼é‡" style="width:60px;">
        <button class="btn-icon btn-primary" onclick="addNewItem()">åŠ å…¥æ¸…å–®</button>
    </div>
</div>

<div class="total-bar" id="totalBar">
    </div>

<script>
    // --- é è¨­è³‡æ–™æ¨¡ç‰ˆ ---
    const defaultItems = [
        { name: "è‘‰é»ƒç´ 100 + èŠéº»ç´ ", note: "1çµ„(2åŒ…)", price: 9164, limit: 1 },
        { name: "é˜²é¢¨é€šè–æ•£ Z", note: "æ¼¢æ–¹æ¸›è‚¥/ä¾¿ç§˜", price: 5318, limit: 2 },
        { name: "æŠ¹èŒ¶ææ‹‰ç±³è˜‡å·§å…‹åŠ›", note: "", price: 828, limit: 2 },
        { name: "Alfort å¸†èˆ¹å·§å…‹åŠ›", note: "", price: 275, limit: 1 },
        { name: "é¾è§’æ•£ å–‰ç³–", note: "é»‘é†‹æ —è—è“", price: 302, limit: 1 },
        { name: "Ora2 Premium ç‰™è†", note: "èŠ³é¦™è–„è·", price: 367, limit: 1 },
        { name: "NONIO ç‰™è†", note: "è—¥ç”¨æ¸…æ¶¼è–„è·", price: 302, limit: 1 },
        { name: "DHC æ­¦é´è‘‰", note: "æ§ç³– 20æ—¥", price: 597, limit: 4 },
        { name: "DHC ç¶­ä»–å‘½C", note: "20æ—¥ä»½", price: 155, limit: 7 },
        { name: "é¾è§’æ•£ ç›´æœé¡†ç²’", note: "è–„è·å‘³", price: 275, limit: 2 },
        { name: "KitKat å·§å…‹åŠ›", note: "æ¿ƒåšæŠ¹èŒ¶", price: 275, limit: 4 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "è‘¡è„", price: 109, limit: 5 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "éºé¦™è‘¡è„", price: 109, limit: 5 },
        { name: "UHAå‘³è¦ºç³– Cororo", note: "20ä¸–ç´€æ¢¨", price: 109, limit: 3 },
        { name: "é¾è§’æ•£ ç›´æœé¡†ç²’", note: "æ°´èœœæ¡ƒå‘³", price: 275, limit: 1 },
        { name: "DHC äºé‰› (é‹…)", note: "20æ—¥ä»½", price: 146, limit: 1 },
        { name: "DHC ç¶œåˆç¶­ä»–å‘½Bç¾¤", note: "20æ—¥ä»½", price: 164, limit: 2 },
        { name: "DHC ç”²æ®¼ç´ ", note: "20æ—¥ä»½", price: 330, limit: 2 },
        { name: "DHC è‚è‡Ÿç²¾è¯+é³¥æ°¨é…¸", note: "20æ—¥ä»½", price: 735, limit: 1 },
        { name: "é€Ÿå¦™åœ“ (å´æŸè‘‰) å–‰ç³–", note: "å‚³çµ±è‰æœ¬", price: 238, limit: 1 },
        { name: "DHC æ¸›è‚¥å¨åŠ›", note: "Diet Power", price: 902, limit: 4 }
    ];

    // --- å…¨å±€ç‹€æ…‹ ---
    const STORAGE_KEY = 'hokkaido_shopping_ultra_v1';
    let appData = {
        users: ["Neo", "Ryan"], // é è¨­ä½¿ç”¨è€…
        orders: [],
        activeOrderId: null
    };

    // --- åˆå§‹åŒ– ---
    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            appData = JSON.parse(saved);
        } else {
            createNewOrder(false); // å»ºç«‹åˆå§‹è¨‚å–®
        }
        
        // é˜²å‘†ï¼šå¦‚æœè®€å–å¾Œæ²’è¨‚å–®æˆ–æ²’ä½¿ç”¨è€…
        if (appData.orders.length === 0) createNewOrder(false);
        if (appData.users.length === 0) appData.users = ["Neo", "Ryan"];
        if (!appData.activeOrderId) appData.activeOrderId = appData.orders[0].id;

        renderAll();
    }

    function createNewOrder(refresh = true) {
        const newId = 'order_' + Date.now();
        // å»ºç«‹æ–°è¨‚å–®æ™‚ï¼Œæ¯å€‹å•†å“çš„ quantities åˆå§‹åŒ–ç‚ºç©ºç‰©ä»¶ {}
        // key å°‡æœƒæ˜¯ä½¿ç”¨è€…åå­—
        const items = defaultItems.map(p => ({
            ...p,
            quantities: {} 
        }));

        appData.orders.push({
            id: newId,
            name: `è³¼ç‰©æ¸…å–® ${appData.orders.length + 1}`,
            items: items
        });
        appData.activeOrderId = newId;
        
        saveData();
        if (refresh) renderAll();
    }

    // --- æˆå“¡ç®¡ç†é‚è¼¯ ---
    function addMember() {
        const input = document.getElementById('newMemberName');
        const name = input.value.trim();
        if (!name) return;
        if (appData.users.includes(name)) {
            alert('æˆå“¡åå­—é‡è¤‡äº†ï¼');
            return;
        }

        appData.users.push(name);
        input.value = '';
        saveData();
        renderAll();
    }

    function removeMember(name) {
        if (!confirm(`ç¢ºå®šè¦ç§»é™¤æˆå“¡ã€Œ${name}ã€å—ï¼Ÿ\nä»–åœ¨æ­¤æ¬¡æ‰€æœ‰è¨‚å–®ä¸­çš„è³¼è²·ç´€éŒ„éƒ½æœƒè¢«åˆªé™¤ï¼`)) return;
        
        // 1. å¾ä½¿ç”¨è€…åˆ—è¡¨ç§»é™¤
        appData.users = appData.users.filter(u => u !== name);
        
        // 2. æ¸…é™¤æ‰€æœ‰è¨‚å–®ä¸­è©²ä½¿ç”¨è€…çš„æ•¸é‡
        appData.orders.forEach(order => {
            order.items.forEach(item => {
                if (item.quantities[name]) {
                    delete item.quantities[name];
                }
            });
        });

        saveData();
        renderAll();
    }

    // --- æ ¸å¿ƒæ¸²æŸ“ ---
    function renderAll() {
        renderMembers();
        renderTabs();
        renderTable(); // åŒ…å«è¡¨é ­èˆ‡å…§å®¹
        calculateTotals();
    }

    function renderMembers() {
        const container = document.getElementById('memberTags');
        container.innerHTML = appData.users.map(u => `
            <div class="member-tag">
                ${u}
                <span class="member-remove" onclick="removeMember('${u}')">Ã—</span>
            </div>
        `).join('');
    }

    function renderTabs() {
        const container = document.getElementById('tabsHeader');
        let html = appData.orders.map(o => `
            <div class="tab ${o.id === appData.activeOrderId ? 'active' : ''}" 
                 onclick="switchTab('${o.id}')">
                ${o.name}
            </div>
        `).join('');
        
        html += `<button class="btn-icon" style="margin-left:5px; background:#ddd;" onclick="createNewOrder()">+</button>`;
        container.innerHTML = html;

        const currentOrder = getCurrentOrder();
        document.getElementById('orderName').value = currentOrder.name;
    }

    function renderTable() {
        const thead = document.getElementById('tableHeader');
        const tbody = document.getElementById('tableBody');
        const order = getCurrentOrder();

        // 1. å»ºç«‹è¡¨é ­
        // å›ºå®šæ¬„ä½
        let headerHTML = `<th>å“é …</th><th>åŸè³¼</th><th>å–®åƒ¹</th>`;
        // å‹•æ…‹ä½¿ç”¨è€…æ¬„ä½
        appData.users.forEach(user => {
            headerHTML += `<th>${user}</th>`;
        });
        // çµå°¾æ¬„ä½
        headerHTML += `<th>å‰©é¤˜</th><th>åˆª</th>`;
        thead.innerHTML = headerHTML;

        // 2. å»ºç«‹è¡¨æ ¼å…§å®¹
        tbody.innerHTML = order.items.map((item, index) => {
            // è¨ˆç®—ç›®å‰å·²åˆ†é…ç¸½æ•¸
            let totalAssigned = 0;
            appData.users.forEach(u => {
                totalAssigned += (item.quantities[u] || 0);
            });
            const remaining = item.limit - totalAssigned;

            // ç‹€æ…‹æ¨£å¼
            let remainClass = 'remain-col';
            let inputClass = '';
            let remainText = remaining;

            if (remaining < 0) {
                remainClass = 'remain-error';
                inputClass = 'input-error';
            } else if (remaining === 0) {
                remainClass = 'remain-ok';
                remainText = 'âœ”';
            }

            // ç”¢ç”Ÿè©²åˆ— HTML
            let rowHTML = `<tr>`;
            
            // å“åèˆ‡åŸè³¼é‡
            rowHTML += `
                <td>
                    <div style="font-weight:500;">${item.name}</div>
                    ${item.note ? `<span class="note">${item.note}</span>` : ''}
                </td>
                <td style="color:#64748b; font-weight:bold;">${item.limit}</td>
                <td style="font-family:monospace; color:#7c3aed;">${item.price}</td>
            `;

            // ä½¿ç”¨è€…è¼¸å…¥æ¡†
            appData.users.forEach(user => {
                const qty = item.quantities[user] || ''; // è‹¥ç„¡å€¼é¡¯ç¤ºç©ºå­—ä¸²
                rowHTML += `
                    <td>
                        <input type="number" class="${inputClass}" 
                               value="${qty}" placeholder="0" min="0"
                               oninput="updateQuantity(${index}, '${user}', this.value)">
                    </td>
                `;
            });

            // å‰©é¤˜é‡èˆ‡åˆªé™¤éˆ•
            rowHTML += `
                <td class="${remainClass}">${remainText}</td>
                <td><button class="btn-icon" style="color:#ccc; background:none;" onclick="deleteItem(${index})">Ã—</button></td>
            `;
            
            rowHTML += `</tr>`;
            return rowHTML;
        }).join('');
    }

    // --- è³‡æ–™æ“ä½œ ---
    function updateQuantity(itemIndex, user, value) {
        const order = getCurrentOrder();
        const val = parseFloat(value) || 0;
        
        // æ›´æ–°è³‡æ–™
        order.items[itemIndex].quantities[user] = val;
        
        saveData();
        // é€™è£¡ç‚ºäº†ä¿æŒè¼¸å…¥ç„¦é»ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹ tableï¼Œåªç”¨ JS è¨ˆç®—æ›´æ–°éƒ¨åˆ† UI æœƒæ¯”è¼ƒé †
        // ä½†ç‚ºäº†ç¨‹å¼ç¢¼ç°¡æ½”ï¼Œé€™è£¡ç›´æ¥é‡æ–°æ¸²æŸ“æœƒæœ‰é–ƒçˆå•é¡Œã€‚
        // æ”¹è‰¯ï¼šåªé‡æ–°è¨ˆç®— Total å’Œ è©²è¡Œçš„æ¨£å¼ï¼Œä¸é‡ç¹ª DOM
        
        // é‡æ–°è¨ˆç®—ç¸½é¡
        calculateTotals();
        
        // æ‰‹å‹•æ›´æ–°è©²è¡Œçš„æ¨£å¼ (é¿å…é‡ç¹ªå°è‡´ focus è·‘æ‰)
        updateRowVisuals(itemIndex); 
    }

    function updateRowVisuals(index) {
        const order = getCurrentOrder();
        const item = order.items[index];
        const row = document.getElementById('tableBody').children[index];
        if (!row) return;

        let totalAssigned = 0;
        appData.users.forEach(u => totalAssigned += (item.quantities[u] || 0));
        const remaining = item.limit - totalAssigned;
        
        // æ›´æ–°å‰©é¤˜æ¬„ä½ (å€’æ•¸ç¬¬äºŒå€‹ td)
        const remainCell = row.children[row.children.length - 2];
        
        // æ›´æ–° Input æ¨£å¼
        const inputs = row.querySelectorAll('input');
        
        if (remaining < 0) {
            remainCell.className = 'remain-error';
            remainCell.textContent = remaining;
            inputs.forEach(input => input.classList.add('input-error'));
        } else if (remaining === 0) {
            remainCell.className = 'remain-ok';
            remainCell.textContent = 'âœ”';
            inputs.forEach(input => input.classList.remove('input-error'));
        } else {
            remainCell.className = '';
            remainCell.textContent = remaining;
            inputs.forEach(input => input.classList.remove('input-error'));
        }
    }

    function addNewItem() {
        const name = document.getElementById('addItemName').value.trim();
        const price = parseFloat(document.getElementById('addItemPrice').value);
        const limit = parseInt(document.getElementById('addItemLimit').value);
        
        if (!name || isNaN(price) || isNaN(limit)) {
            alert('è«‹å®Œæ•´å¡«å¯«å“é …è³‡è¨Š');
            return;
        }

        getCurrentOrder().items.push({
            name, price, limit, note: 'è‡ªè¨‚', quantities: {}
        });

        // æ¸…ç©º
        document.getElementById('addItemName').value = '';
        document.getElementById('addItemPrice').value = '';
        document.getElementById('addItemLimit').value = '';
        
        saveData();
        renderTable();
        calculateTotals();
    }

    function deleteItem(index) {
        if(confirm('åˆªé™¤æ­¤å“é …ï¼Ÿ')) {
            getCurrentOrder().items.splice(index, 1);
            saveData();
            renderTable();
            calculateTotals();
        }
    }

    function calculateTotals() {
        const order = getCurrentOrder();
        const totals = {}; // { 'Neo': 1000, 'Ryan': 500 }
        let grandTotal = 0;

        // åˆå§‹åŒ–
        appData.users.forEach(u => totals[u] = 0);

        // è¨ˆç®—
        order.items.forEach(item => {
            appData.users.forEach(user => {
                const qty = item.quantities[user] || 0;
                const cost = qty * item.price;
                totals[user] += cost;
                grandTotal += cost;
            });
        });

        // æ¸²æŸ“åº•éƒ¨
        const bar = document.getElementById('totalBar');
        let html = `<div class="total-grand">ç¸½è¨ˆ $${grandTotal.toLocaleString()}</div>`;
        
        appData.users.forEach(user => {
            html += `
                <div class="total-user">
                    ${user}
                    <span>$${totals[user].toLocaleString()}</span>
                </div>
            `;
        });
        
        bar.innerHTML = html;
    }

    // --- é€šç”¨å·¥å…· ---
    function getCurrentOrder() {
        return appData.orders.find(o => o.id === appData.activeOrderId);
    }

    function switchTab(id) {
        appData.activeOrderId = id;
        saveData();
        renderAll();
    }

    function updateOrderName(val) {
        getCurrentOrder().name = val;
        saveData();
        renderTabs();
    }

    function deleteCurrentOrder() {
        if (appData.orders.length <= 1) {
            alert('è‡³å°‘éœ€ä¿ç•™ä¸€å¼µè¨‚å–®');
            return;
        }
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®é é¢ï¼Ÿ')) {
            appData.orders = appData.orders.filter(o => o.id !== appData.activeOrderId);
            appData.activeOrderId = appData.orders[0].id;
            saveData();
            renderAll();
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    // Start
    init();
</script>

</body>
</html>